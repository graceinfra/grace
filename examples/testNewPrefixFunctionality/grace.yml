config:
  profile: zosmf
  concurrency: 2
  defaults:
    compiler:
      pgm: IGYCRCTL
      parms: 'OBJECT,NODECK,LIB,APOST'
      steplib: IGY.V6R4M0.SIGYCOMP
    linker:
      pgm: IEWL
      parms: 'LIST,MAP,XREF'
  cleanup:
    on_success: true
    on_failure: false

datasets:
  jcl: IBMUSER.GRCFTEST.JCL
  src: IBMUSER.GRCFTEST.SRC
  loadlib: IBMUSER.LOAD

jobs:
  - name: GENINPUT
    type: shell
    with:
      inline: |
        echo "This is initial data generated by a shell job." > "$GRACE_OUTPUT_LCLDATA"
        echo "KeyParameter=ABC123" >> "$GRACE_OUTPUT_LCLDATA"
        echo "Timestamp=$(date)" >> "$GRACE_OUTPUT_LCLDATA"
        echo "Shell job GENINPUT created $GRACE_OUTPUT_LCLDATA"
    outputs:
      - name: LCLDATA
        path: local-temp://initial-data.txt
        encoding: text

  - name: CMPLMYPG
    type: compile
    depends_on: [GENINPUT]
    inputs:
      - name: SYSIN
        path: src://MYPROG.CBL
      - name: PARAMDAT
        path: local-temp://initial-data.txt
        encoding: text
      - name: EXTRAPRM
        path: file://./extra-parms.txt
        encoding: text
    outputs:
      - name: SYSLIN
        path: zos-temp://myprog.obj
        keep: false
      - name: SYSPRINT
        path: file://./compile-sysprint.log
        encoding: text
        keep: true

  - name: LNKMYPG
    type: linkedit
    depends_on: [CMPLMYPG]
    program: MYPROG
    inputs:
      - name: SYSLIN
        path: zos-temp://myprog.obj

  - name: RUNMYPG
    type: execute
    depends_on: [LNKMYPG]
    program: MYPROG
    inputs:
      - name: SYSUT1
        path: file://./runtime-input.dat
        encoding: text
      - name: PARAMCRD
        path: local-temp://initial-data.txt
        encoding: text
      - name: PARAMDAT
        path: local-temp://initial-data.txt
        encoding: text
      - name: EXTRAPRM
        path: file://./extra-parms.txt
        encoding: text
    outputs:
      - name: SYSUT2
        path: local-temp://final-output.txt
        encoding: text
        keep: false
      - name: REPORTDD
        path: file://./execution-report.txt
        encoding: text
        dcb: "(RECFM=FB,LRECL=133,BLKSIZE=13300)" # Match COBOL FD
        keep: true

  - name: VFYOUT
    type: shell
    depends_on: [RUNMYPG]
    with:
      inline: |
        echo "--- Verifying content of final-output.txt (from $GRACE_INPUT_FINALOUT) ---"
        if [ -f "$GRACE_INPUT_FINALOUT" ]; then
          cat "$GRACE_INPUT_FINALOUT"
          if grep -iq "PROCESSED: This is runtime data" "$GRACE_INPUT_FINALOUT"; then
            echo "SUCCESS: Found expected processed line in final-output.txt"
          else
            echo "ERROR: Did not find expected processed line in final-output.txt"
            exit 1
          fi
        else
          echo "ERROR: $GRACE_INPUT_FINALOUT not found!"
          exit 1
        fi
        echo "--- Verification complete. ---"
        echo "Local execution report also available at ./execution-report.txt (if RUNMYPG created it)."
    inputs:
      - name: FINALOUT
        path: file://final-output.txt
        encoding: text
